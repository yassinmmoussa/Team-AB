'use strict'

const BB = require('bluebird')

const figgyPudding = require('figgy-pudding')
const fixOwner = require('./fix-owner')
const path = require('path')
const rimraf = BB.promisify(require('rimraf'))
const uniqueFilename = require('unique-filename')

const TmpOpts = figgyPudding({
<<<<<<< HEAD
  tmpPrefix: {},
  uid: {},
  gid: {}
=======
  tmpPrefix: {}
>>>>>>> 0ae1a948acc774b725d2813ed0b826c52e048967
})

module.exports.mkdir = mktmpdir
function mktmpdir (cache, opts) {
  opts = TmpOpts(opts)
  const tmpTarget = uniqueFilename(path.join(cache, 'tmp'), opts.tmpPrefix)
<<<<<<< HEAD
  return fixOwner.mkdirfix(tmpTarget, opts.uid, opts.gid).then(() => {
=======
  return fixOwner.mkdirfix(cache, tmpTarget).then(() => {
>>>>>>> 0ae1a948acc774b725d2813ed0b826c52e048967
    return tmpTarget
  })
}

module.exports.withTmp = withTmp
function withTmp (cache, opts, cb) {
  if (!cb) {
    cb = opts
    opts = null
  }
  opts = TmpOpts(opts)
  return BB.using(mktmpdir(cache, opts).disposer(rimraf), cb)
}

module.exports.fix = fixtmpdir
<<<<<<< HEAD
function fixtmpdir (cache, opts) {
  opts = TmpOpts(opts)
  return fixOwner(path.join(cache, 'tmp'), opts.uid, opts.gid)
=======
function fixtmpdir (cache) {
  return fixOwner(cache, path.join(cache, 'tmp'))
>>>>>>> 0ae1a948acc774b725d2813ed0b826c52e048967
}
